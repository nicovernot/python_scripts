<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Loto/Keno - Gestion des Fichiers</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.24.1/themes/prism.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <style>
        .file-card {
            transition: all 0.3s ease;
            border-left: 4px solid #007bff;
        }
        .file-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,123,255,.3);
        }
        .strategy-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .stats-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .file-size {
            font-size: 0.8em;
            color: #6c757d;
        }
        .category-badge {
            font-size: 0.7em;
        }
        .loading {
            display: none;
        }
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        .markdown-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            color: #2c3e50;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        
        .markdown-content h1 { border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .markdown-content h2 { border-bottom: 1px solid #bdc3c7; padding-bottom: 5px; }
        
        .markdown-content code {
            background-color: #f8f9fa;
            color: #e83e8c;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .markdown-content pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            overflow-x: auto;
        }
        
        .markdown-content pre code {
            background: none;
            color: inherit;
            padding: 0;
        }
        
        .markdown-content blockquote {
            border-left: 4px solid #3498db;
            background-color: #f8f9fa;
            padding: 10px 20px;
            margin: 15px 0;
        }
        
        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
        }
        
        .markdown-content table th,
        .markdown-content table td {
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            text-align: left;
        }
        
        .markdown-content table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .csv-table {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            max-height: 500px;
            overflow: auto;
        }
        
        .csv-table .table-responsive {
            border: 1px solid #dee2e6;
            border-radius: 6px;
        }
        
        .csv-table table {
            font-size: 0.85em;
        }
        
        .csv-table th {
            background: #007bff;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            font-weight: 600;
            border-top: none;
        }
        
        .csv-table td {
            white-space: nowrap;
        }
        
        /* Styles pour les tableaux triables */
        .sortable th {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px !important;
        }
        
        .sortable th:hover {
            background-color: #0056b3 !important;
        }
        
        .sortable th::after {
            content: '‚ÜïÔ∏è';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.7;
            font-size: 0.8em;
        }
        
        .sortable th.sort-up::after {
            content: '‚¨ÜÔ∏è';
            opacity: 1;
        }
        
        .sortable th.sort-down::after {
            content: '‚¨áÔ∏è';
            opacity: 1;
        }
        
        .sortable th.sort-up,
        .sortable th.sort-down {
            background-color: #28a745 !important;
        }
        
        .sort-info {
            font-size: 0.8em;
            color: #6c757d;
            margin-bottom: 10px;
            padding: 5px 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #007bff;
        }
        
        .download-link-section {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 6px;
            padding: 10px 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .copy-btn {
            padding: 4px 8px;
            font-size: 0.8em;
            border-radius: 4px;
        }
        .file-preview {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: white;
        }
        
        /* Styles pour la section rapport markdown */
        .markdown-content h1, .markdown-content h2, .markdown-content h3, 
        .markdown-content h4, .markdown-content h5, .markdown-content h6 {
            color: #2c3e50;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        
        .markdown-content h1 { font-size: 1.5em; border-bottom: 2px solid #e9ecef; padding-bottom: 0.3em; }
        .markdown-content h2 { font-size: 1.3em; border-bottom: 1px solid #e9ecef; padding-bottom: 0.3em; }
        .markdown-content h3 { font-size: 1.1em; }
        
        .markdown-content ul, .markdown-content ol {
            margin-left: 20px;
        }
        
        .markdown-content li {
            margin-bottom: 0.3em;
        }
        
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
        }
        
        .markdown-content th, .markdown-content td {
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            text-align: left;
        }
        
        .markdown-content th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        .markdown-content code {
            background-color: #f8f9fa;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .markdown-content pre {
            background-color: #f8f9fa;
            padding: 1em;
            border-radius: 5px;
            overflow-x: auto;
        }
        
        .markdown-content blockquote {
            border-left: 4px solid #007bff;
            padding-left: 1em;
            margin-left: 0;
            font-style: italic;
            color: #6c757d;
        }
        
        /* Am√©lioration de l'affichage des boutons */
        #statusBtn {
            min-width: 140px;
            white-space: nowrap;
        }
        
        .d-flex.gap-2 {
            gap: 0.5rem !important;
        }
        
        .btn-sm {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-dice me-2"></i>Dashboard Loto/Keno
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link me-2" href="/generator">
                    <i class="fas fa-magic me-1"></i>G√©n√©rateur
                </a>
                <button class="btn btn-outline-light me-2" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Actualiser
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- S√©lecteur de jeu -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-gamepad me-2"></i>S√©lection du Jeu
                        </h5>
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="gameType" id="keno" value="keno" checked>
                            <label class="btn btn-outline-primary" for="keno">
                                <i class="fas fa-circle me-1"></i>Keno
                            </label>
                            <input type="radio" class="btn-check" name="gameType" id="loto" value="loto">
                            <label class="btn btn-outline-primary" for="loto">
                                <i class="fas fa-star me-1"></i>Loto
                            </label>
                        </div>
                        
                        <!-- Actions de t√©l√©chargement -->
                        <div class="mt-3">
                            <h6 class="text-muted mb-2">
                                <i class="fas fa-download me-1"></i>T√©l√©chargement de donn√©es
                            </h6>
                            <div class="btn-group" role="group">
                                <button class="btn btn-success btn-sm" onclick="downloadData('keno')" id="downloadKenoBtn">
                                    <i class="fas fa-download me-1"></i>T√©l√©charger donn√©es Keno
                                </button>
                                <button class="btn btn-info btn-sm" onclick="downloadData('loto')" id="downloadLotoBtn">
                                    <i class="fas fa-download me-1"></i>T√©l√©charger donn√©es Loto
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="updateAllData()" id="updateAllBtn">
                                    <i class="fas fa-sync-alt me-1"></i>Mettre √† jour tout
                                </button>
                            </div>
                            <div class="progress mt-2" style="height: 6px; display: none;" id="downloadProgress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted d-block mt-1">T√©l√©charge automatiquement les derni√®res donn√©es depuis FDJ</small>
                        </div>
                        
                        <!-- Actions d'analyse -->
                        <div class="mt-3 border-top pt-3">
                            <h6 class="text-muted mb-2">
                                <i class="fas fa-chart-line me-1"></i>Analyses compl√®tes
                            </h6>
                            
                            <!-- Options d'analyse Keno -->
                            <div class="mb-3" id="kenoOptions">
                                <div class="row">
                                    <!-- Param√®tres de strat√©gies -->
                                    <div class="col-md-6 mb-3">
                                        <label for="kenoStrategiesCount" class="form-label">
                                            <i class="fas fa-chess me-1"></i>Nombre de strat√©gies
                                        </label>
                                        <input type="number" class="form-control" id="kenoStrategiesCount" 
                                               value="7" min="1" max="15" 
                                               title="Nombre de strat√©gies √† g√©n√©rer (1-15)">
                                        <small class="text-muted">Plus de strat√©gies = analyse plus compl√®te</small>
                                    </div>
                                    
                                    <!-- Source de donn√©es -->
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-database me-1"></i>Source de donn√©es
                                        </label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="kenoDataSource" 
                                                   id="kenoDataClassic" value="classic" checked>
                                            <label class="form-check-label" for="kenoDataClassic">
                                                Fichiers CSV classiques
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="kenoDataSource" 
                                                   id="kenoDataConsolidated" value="consolidated">
                                            <label class="form-check-label" for="kenoDataConsolidated">
                                                Fichier consolid√© (optimis√©)
                                            </label>
                                        </div>
                                        <small class="text-muted">Le fichier consolid√© est plus rapide si disponible</small>
                                    </div>
                                    
                                    <!-- Type d'analyse -->
                                    <div class="col-12 mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-cogs me-1"></i>Type d'analyse
                                        </label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="kenoAnalysisType" 
                                                   id="kenoAnalysisStandard" value="standard" checked>
                                            <label class="form-check-label" for="kenoAnalysisStandard">
                                                <strong>Standard</strong> - Analyse rapide avec strat√©gies principales
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="kenoAnalysisType" 
                                                   id="kenoAnalysisDeep" value="deep">
                                            <label class="form-check-label" for="kenoAnalysisDeep">
                                                <strong>Approfondie</strong> - Analyse ML avanc√©e et mod√®les pr√©dictifs
                                            </label>
                                        </div>
                                        <small class="text-muted">L'analyse approfondie inclut machine learning et pr√©dictions</small>
                                    </div>
                                    
                                    <!-- Options d'export -->
                                    <div class="col-12 mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-download me-1"></i>Options d'export
                                        </label>
                                        <div class="row">
                                            <div class="col-sm-4">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="kenoOptionPlots" checked>
                                                    <label class="form-check-label" for="kenoOptionPlots">
                                                        <i class="fas fa-chart-bar me-1"></i>Graphiques
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-sm-4">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="kenoOptionCSV" checked>
                                                    <label class="form-check-label" for="kenoOptionCSV">
                                                        <i class="fas fa-file-csv me-1"></i>Statistiques CSV
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-sm-4">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="kenoOptionMarkdown" checked>
                                                    <label class="form-check-label" for="kenoOptionMarkdown">
                                                        <i class="fab fa-markdown me-1"></i>Rapport Markdown
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Options avanc√©es -->
                                    <div class="col-12">
                                        <div class="card bg-light">
                                            <div class="card-body p-3">
                                                <h6 class="card-title mb-2">
                                                    <i class="fas fa-sliders-h me-1"></i>Options avanc√©es
                                                </h6>
                                                <div class="row">
                                                    <div class="col-sm-6">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="kenoOptionMachineLearning">
                                                            <label class="form-check-label" for="kenoOptionMachineLearning">
                                                                <i class="fas fa-robot me-1"></i>Machine Learning
                                                            </label>
                                                        </div>
                                                        <small class="text-muted d-block">Mod√®les pr√©dictifs ML</small>
                                                    </div>
                                                    <div class="col-sm-6">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="kenoOptionTrendAnalysis">
                                                            <label class="form-check-label" for="kenoOptionTrendAnalysis">
                                                                <i class="fas fa-trending-up me-1"></i>Analyse tendances
                                                            </label>
                                                        </div>
                                                        <small class="text-muted d-block">√âvolutions r√©centes</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Options d'analyse Loto -->
                            <div class="mb-3" id="lotoOptions" style="display: none;">
                                <div class="row">
                                    <div class="col-12 mb-2">
                                        <small class="text-muted">Options d'export :</small>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="lotoOptionPlots" checked>
                                            <label class="form-check-label" for="lotoOptionPlots">
                                                <i class="fas fa-chart-bar me-1"></i>Graphiques
                                            </label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="lotoOptionCSV" checked>
                                            <label class="form-check-label" for="lotoOptionCSV">
                                                <i class="fas fa-file-csv me-1"></i>CSV
                                            </label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="lotoOptionMarkdown" checked>
                                            <label class="form-check-label" for="lotoOptionMarkdown">
                                                <i class="fab fa-markdown me-1"></i>Markdown
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Nombre de grilles :</small>
                                        <input type="number" class="form-control form-control-sm" id="lotoGrids" value="3" min="1" max="10">
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Strat√©gie :</small>
                                        <select class="form-select form-select-sm" id="lotoStrategy">
                                            <option value="equilibre" selected>√âquilibre</option>
                                            <option value="focus_retard">Focus Retard</option>
                                            <option value="momentum">Momentum</option>
                                            <option value="frequences_moyennes">Fr√©quences Moyennes</option>
                                            <option value="equilibre_conservateur">√âquilibre Conservateur</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="btn-group" role="group">
                                <button class="btn btn-primary btn-sm" onclick="selectAnalysisType('keno')" id="selectKenoBtn">
                                    <i class="fas fa-chart-bar me-1"></i>Analyser Keno
                                </button>
                                <button class="btn btn-outline-primary btn-sm" onclick="selectAnalysisType('loto')" id="selectLotoBtn">
                                    <i class="fas fa-chart-line me-1"></i>G√©n√©rer grilles Loto
                                </button>
                            </div>
                            
                            <div class="d-flex gap-2 mt-2">
                                <button class="btn btn-success btn-sm" onclick="runSelectedAnalysis()" id="runAnalysisBtn" style="display: none;">
                                    <i class="fas fa-play me-1"></i>Lancer l'analyse
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="checkAnalysisStatus()" id="statusBtn">
                                    <i class="fas fa-info-circle me-1"></i>Statut analyses
                                </button>
                            </div>
                            <div class="progress mt-2" style="height: 6px; display: none;" id="analysisProgress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div id="analysisStatus" class="mt-2" style="display: none;">
                                <div class="alert alert-info alert-sm mb-0" role="alert">
                                    <div id="analysisStatusText">Analyse en cours...</div>
                                    <div class="mt-1">
                                        <small class="text-muted" id="analysisDetails">Initialisation...</small>
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted d-block mt-1">Lance les analyses statistiques compl√®tes avec graphiques et exports</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Indicateurs de chargement -->
        <div class="loading" id="loadingIndicator">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
                <p class="mt-2">Chargement des donn√©es...</p>
            </div>
        </div>

        <!-- Rapport d'analyse -->
        <div id="analysisReport" style="display: none;" class="mb-4">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>Rapport d'Analyse
                        <button type="button" class="btn btn-sm btn-outline-light float-end" onclick="closeAnalysisReport()">
                            <i class="fas fa-times"></i>
                        </button>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">üìä Informations G√©n√©rales</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Type de jeu:</strong></td><td id="reportGameType">-</td></tr>
                                <tr><td><strong>Dur√©e d'analyse:</strong></td><td id="reportDuration">-</td></tr>
                                <tr><td><strong>Statut:</strong></td><td id="reportStatus">-</td></tr>
                                <tr><td><strong>Timestamp:</strong></td><td id="reportTimestamp">-</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">üìà Statistiques</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Tirages analys√©s:</strong></td><td id="reportTotalDraws">-</td></tr>
                                <tr><td><strong>Score ML:</strong></td><td id="reportMLScore">-</td></tr>
                                <tr><td><strong>Num√©ros analys√©s:</strong></td><td id="reportNumbersAnalyzed">-</td></tr>
                                <tr><td><strong>Paires analys√©es:</strong></td><td id="reportPairsAnalyzed">-</td></tr>
                            </table>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="text-primary">üìã R√©sum√©</h6>
                            <p id="reportSummary" class="text-muted">-</p>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <h6 class="text-success">üìä Graphiques d'Analyse</h6>
                            <ul id="reportPlots" class="list-unstyled text-muted">
                                <li>Aucun graphique g√©n√©r√©</li>
                            </ul>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-info">üìÑ Exports CSV</h6>
                            <ul id="reportExports" class="list-unstyled text-muted">
                                <li>Aucun export g√©n√©r√©</li>
                            </ul>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-warning">üìù Rapports Markdown</h6>
                            <ul id="reportMarkdown" class="list-unstyled text-muted">
                                <li>Aucun rapport g√©n√©r√©</li>
                            </ul>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-secondary">üìã Rapports Texte</h6>
                            <ul id="reportTexts" class="list-unstyled text-muted">
                                <li>Aucun rapport g√©n√©r√©</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Section pour afficher le contenu du rapport -->
                    <div class="row mt-4" id="reportContentSection" style="display: none;">
                        <div class="col-12">
                            <h6 class="text-primary">üìÑ Contenu du Rapport</h6>
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span id="reportFileName" class="fw-bold">Rapport g√©n√©r√©</span>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleReportContent()">
                                        <span id="toggleIcon">‚ñº</span> <span id="toggleText">Masquer</span>
                                    </button>
                                </div>
                                <div class="card-body" id="reportContentBody" style="max-height: 400px; overflow-y: auto;">
                                    <div id="reportContent" class="markdown-content"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3" id="reportRecommendations">
                        <div class="col-12">
                            <h6 class="text-primary">üéØ Recommandations</h6>
                            <div id="reportRecommendationsList" class="text-muted">
                                Aucune recommandation disponible
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard principal -->
        <div id="dashboard" class="row">
            <!-- Recommandations de strat√©gies -->
            <div class="col-lg-4 mb-4">
                <div class="card strategy-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-lightbulb me-2"></i>Strat√©gie Recommand√©e
                        </h5>
                        <div id="strategyRecommendation">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistiques rapides -->
            <div class="col-lg-4 mb-4">
                <div class="card stats-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-chart-line me-2"></i>Statistiques
                        </h5>
                        <div id="quickStats">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statut des donn√©es -->
            <div class="col-lg-4 mb-4">
                <div class="card bg-success text-white h-100">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-database me-2"></i>Statut des Donn√©es
                        </h5>
                        <div id="dataStatus">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section des fichiers -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-folder-open me-2"></i>Fichiers G√©n√©r√©s
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="filesContainer">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-2">Chargement des fichiers...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour visualiser les fichiers -->
    <div class="modal fade" id="fileModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fileModalTitle">Aper√ßu du fichier</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="fileModalBody">
                    <div id="filePreviewContainer" class="file-preview">
                        <!-- Contenu du fichier -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <button type="button" class="btn btn-primary" id="downloadFileBtn">
                        <i class="fas fa-download me-1"></i>T√©l√©charger
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.24.1/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.24.1/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tablesort@5.3.0/dist/tablesort.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tablesort@5.3.0/dist/sorts/tablesort.number.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tablesort@5.3.0/dist/sorts/tablesort.date.min.js"></script>
    <script>
        let currentGameType = 'keno';
        let apiBaseUrl = window.location.origin;
        let currentFilePath = '';

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Configuration de Marked.js apr√®s chargement des librairies
            if (typeof marked !== 'undefined' && typeof hljs !== 'undefined') {
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    headerIds: true,
                    mangle: false,
                    pedantic: false,
                    sanitize: false,
                    silent: false,
                    smartLists: true,
                    smartypants: true,
                    xhtml: false,
                    highlight: function(code, lang) {
                        if (lang && hljs.getLanguage(lang)) {
                            try {
                                return hljs.highlight(code, { language: lang }).value;
                            } catch (err) {}
                        }
                        return hljs.highlightAuto(code).value;
                    }
                });
            }
            
            setupEventListeners();
            loadDashboard();
            
            // Initialiser les tableaux triables p√©riodiquement
            setInterval(initializeSortableTables, 2000);
        });

        function setupEventListeners() {
            // Changement de type de jeu
            document.querySelectorAll('input[name="gameType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        currentGameType = this.value;
                        loadDashboard();
                    }
                });
            });
        }

        async function loadDashboard() {
            showLoading(true);
            try {
                // Charger les donn√©es du dashboard
                const response = await fetch(`${apiBaseUrl}/api/dashboard/${currentGameType}`);
                const data = await response.json();

                if (data.success) {
                    updateDashboard(data.data);
                } else {
                    showError('Erreur lors du chargement du dashboard: ' + data.message);
                }
            } catch (error) {
                showError('Erreur de connexion √† l\'API: ' + error.message);
            }
            showLoading(false);
        }

        function updateDashboard(data) {
            updateStrategyRecommendation(data.strategy_recommendations);
            updateQuickStats(data.files);
            updateDataStatus(data.data_status);
            updateFilesContainer(data.files);
        }

        function updateStrategyRecommendation(recommendations) {
            const container = document.getElementById('strategyRecommendation');
            if (recommendations && recommendations.primary_strategy) {
                container.innerHTML = `
                    <div class="mb-3">
                        <h6 class="fw-bold">${recommendations.primary_strategy}</h6>
                        <div class="progress mb-2">
                            <div class="progress-bar" style="width: ${recommendations.confidence}%"></div>
                        </div>
                        <small>Confiance: ${recommendations.confidence}%</small>
                    </div>
                    <ul class="list-unstyled mb-0">
                        ${recommendations.recommendations.map(rec => 
                            `<li><i class="fas fa-arrow-right me-1"></i>${rec.message}</li>`
                        ).join('')}
                    </ul>
                `;
            } else {
                container.innerHTML = '<p class="mb-0">Aucune recommandation disponible</p>';
            }
        }

        function updateQuickStats(files) {
            const container = document.getElementById('quickStats');
            let totalFiles = 0;
            let totalSize = 0;
            
            for (const [category, fileList] of Object.entries(files)) {
                totalFiles += fileList.length;
                fileList.forEach(file => totalSize += file.size);
            }

            container.innerHTML = `
                <div class="row text-center">
                    <div class="col-6">
                        <h3 class="mb-0">${totalFiles}</h3>
                        <small>Fichiers</small>
                    </div>
                    <div class="col-6">
                        <h3 class="mb-0">${formatFileSize(totalSize)}</h3>
                        <small>Taille totale</small>
                    </div>
                </div>
            `;
        }

        function updateDataStatus(status) {
            const container = document.getElementById('dataStatus');
            // Simulation du statut (√† adapter selon votre API)
            container.innerHTML = `
                <div class="mb-2">
                    <i class="fas fa-check-circle me-2"></i>Donn√©es √† jour
                </div>
                <div class="mb-2">
                    <i class="fas fa-clock me-2"></i>Derni√®re maj: aujourd'hui
                </div>
                <div>
                    <i class="fas fa-chart-bar me-2"></i>Analyses disponibles
                </div>
            `;
        }

        function updateFilesContainer(files) {
            const container = document.getElementById('filesContainer');
            let html = '';

            if (Object.keys(files).length === 0) {
                html = '<p class="text-muted text-center">Aucun fichier disponible</p>';
            } else {
                for (const [category, fileList] of Object.entries(files)) {
                    if (fileList.length > 0) {
                        html += `
                            <div class="mb-4">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-folder me-2"></i>${getCategoryName(category)}
                                </h6>
                                <div class="row">
                                    ${fileList.map(file => createFileCard(file)).join('')}
                                </div>
                            </div>
                        `;
                    }
                }
            }

            container.innerHTML = html;
        }

        function createFileCard(file) {
            const categoryIcon = getCategoryIcon(file.category);
            const categoryColor = getCategoryColor(file.category);
            const previewIcon = getPreviewIcon(file.extension);
            
            return `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card file-card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0" title="${file.name}">
                                    <i class="fas fa-${previewIcon} me-1"></i>
                                    ${file.name.length > 20 ? file.name.substring(0, 20) + '...' : file.name}
                                </h6>
                                <span class="badge bg-${categoryColor} category-badge">
                                    <i class="fas fa-${categoryIcon} me-1"></i>${file.category}
                                </span>
                            </div>
                            <p class="file-size mb-2">
                                <i class="fas fa-weight-hanging me-1"></i>${file.size_human} ‚Ä¢ 
                                <i class="fas fa-clock me-1"></i>${formatDate(file.modified)}
                            </p>
                            <div class="mb-2">
                                <small class="text-muted">${getFileDescription(file)}</small>
                            </div>
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-outline-primary btn-sm" onclick="viewFile('${file.path}', '${file.name}')" title="Aper√ßu format√©">
                                    <i class="fas fa-eye"></i> Voir
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="downloadFile('${file.path}', '${file.name}')" title="T√©l√©charger">
                                    <i class="fas fa-download"></i> DL
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getPreviewIcon(extension) {
            const icons = {
                '.csv': 'table',
                '.md': 'file-text',
                '.txt': 'file-alt',
                '.json': 'code',
                '.png': 'image',
                '.jpg': 'image',
                '.jpeg': 'image'
            };
            return icons[extension] || 'file';
        }

        function getFileDescription(file) {
            const ext = file.extension.toLowerCase();
            switch (ext) {
                case '.csv':
                    return 'üìä Tableau de donn√©es';
                case '.md':
                    return 'üìù Rapport format√©';
                case '.txt':
                    return 'üìÑ Rapport texte';
                case '.json':
                    return 'üîß Donn√©es JSON';
                case '.png':
                case '.jpg':
                case '.jpeg':
                    return 'üñºÔ∏è Graphique';
                default:
                    return 'üìé Fichier';
            }
        }

        function getCategoryName(category) {
            const names = {
                'keno_csv': 'Exports CSV Keno',
                'keno_plots': 'Graphiques d\'Analyse Keno',
                'loto_csv': 'Exports CSV Loto',
                'loto_plots': 'Graphiques d\'Analyse Loto'
            };
            return names[category] || category;
        }

        function getCategoryIcon(category) {
            const icons = {
                'visualization': 'chart-bar',
                'data': 'table',
                'analysis': 'brain',
                'report': 'file-alt',
                'other': 'file'
            };
            return icons[category] || 'file';
        }

        function getCategoryColor(category) {
            const colors = {
                'visualization': 'success',
                'data': 'info',
                'analysis': 'warning',
                'report': 'secondary',
                'other': 'light'
            };
            return colors[category] || 'light';
        }

        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleDateString('fr-FR');
        }

        function formatFileSize(bytes) {
            const units = ['B', 'KB', 'MB', 'GB'];
            let size = bytes;
            let unitIndex = 0;
            
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }
            
            return `${size.toFixed(1)} ${units[unitIndex]}`;
        }

        async function viewFile(filePath, fileName) {
            currentFilePath = filePath;
            document.getElementById('fileModalTitle').textContent = fileName;
            
            try {
                const extension = fileName.split('.').pop().toLowerCase();
                const viewUrl = `${apiBaseUrl}/api/files/view/${filePath}`;
                const downloadUrl = `${apiBaseUrl}/api/files/download/${filePath}`;
                const fullDownloadUrl = `${window.location.origin}${downloadUrl}`;
                
                // Afficher un indicateur de chargement
                document.getElementById('filePreviewContainer').innerHTML = `
                    <div class="text-center p-4">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Chargement...</p>
                    </div>
                `;
                
                // Ajouter le lien de t√©l√©chargement en haut
                const downloadLinkHtml = `
                    <div class="mb-3 p-2 bg-light border rounded">
                        <div class="row align-items-center">
                            <div class="col">
                                <small class="text-muted d-block">Lien de t√©l√©chargement :</small>
                                <input type="text" class="form-control form-control-sm" value="${fullDownloadUrl}" readonly onclick="this.select()">
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('${fullDownloadUrl}')" title="Copier le lien">
                                    <i class="fas fa-copy"></i> Copier
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                let content = '';
                
                if (['png', 'jpg', 'jpeg'].includes(extension)) {
                    // Images
                    content = downloadLinkHtml + `<img src="${viewUrl}" class="img-fluid" alt="${fileName}" style="max-height: 500px;">`;
                    
                } else if (extension === 'csv') {
                    // CSV avec formatage en tableau am√©lior√©
                    const response = await fetch(viewUrl);
                    const csvText = await response.text();
                    content = downloadLinkHtml + formatCSVAsTable(csvText, fileName);
                    
                } else if (['md', 'markdown'].includes(extension)) {
                    // Markdown avec interpr√©tation
                    const response = await fetch(viewUrl);
                    const markdownText = await response.text();
                    content = downloadLinkHtml + `<div class="markdown-content">${marked.parse(markdownText)}</div>`;
                    
                } else if (extension === 'txt') {
                    // Fichiers texte
                    const response = await fetch(viewUrl);
                    const textContent = await response.text();
                    content = downloadLinkHtml + `<pre class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">${escapeHtml(textContent)}</pre>`;
                    
                } else if (extension === 'json') {
                    // JSON format√©
                    const response = await fetch(viewUrl);
                    const jsonContent = await response.json();
                    content = downloadLinkHtml + `<pre class="bg-dark text-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">${JSON.stringify(jsonContent, null, 2)}</pre>`;
                    
                } else {
                    // Fallback iframe
                    content = downloadLinkHtml + `<iframe src="${viewUrl}" style="width:100%;height:400px;border:none;"></iframe>`;
                }
                
                document.getElementById('filePreviewContainer').innerHTML = content;
                
                // Initialiser les tableaux triables apr√®s un court d√©lai
                setTimeout(() => {
                    initializeSortableTables();
                }, 200);
                
                // Configurer le bouton de t√©l√©chargement
                document.getElementById('downloadFileBtn').onclick = () => downloadFile(filePath, fileName);
                
                // Afficher le modal
                const modal = new bootstrap.Modal(document.getElementById('fileModal'));
                modal.show();
                
            } catch (error) {
                showError('Erreur lors de l\'ouverture du fichier: ' + error.message);
            }
        }

        function formatCSVAsTable(csvText, fileName) {
            try {
                // Nettoyer le texte CSV
                const cleanCsvText = csvText.trim();
                
                if (!cleanCsvText) {
                    return `<div class="alert alert-info">Fichier CSV vide</div>`;
                }
                
                // Essayer plusieurs configurations de parsing
                let parsed = null;
                let delimiter = ',';
                
                // D√©tecter le s√©parateur
                const separators = [',', ';', '\t', '|'];
                for (const sep of separators) {
                    const testParse = Papa.parse(cleanCsvText, { 
                        delimiter: sep, 
                        header: false,
                        skipEmptyLines: true 
                    });
                    
                    if (testParse.data.length > 0 && testParse.data[0].length > 1) {
                        delimiter = sep;
                        break;
                    }
                }
                
                // Parser avec le bon d√©limiteur
                parsed = Papa.parse(cleanCsvText, { 
                    delimiter: delimiter,
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: true
                });
                
                if (parsed.errors.length > 0) {
                    console.warn('Erreurs de parsing CSV:', parsed.errors);
                    // Essayer sans header si erreur
                    parsed = Papa.parse(cleanCsvText, { 
                        delimiter: delimiter,
                        header: false,
                        skipEmptyLines: true
                    });
                    
                    if (parsed.errors.length > 0) {
                        return `
                            <div class="alert alert-warning">
                                <strong>Erreur de parsing CSV:</strong> ${parsed.errors[0].message}<br>
                                <small>D√©limiteur d√©tect√©: "${delimiter}"</small><br>
                                <details class="mt-2">
                                    <summary>Affichage brut</summary>
                                    <pre class="mt-2 bg-light p-2" style="max-height: 200px; overflow-y: auto;">${escapeHtml(cleanCsvText.substring(0, 1000))}${cleanCsvText.length > 1000 ? '...' : ''}</pre>
                                </details>
                            </div>
                        `;
                    }
                }
                
                const data = parsed.data.filter(row => row && Object.keys(row).length > 0);
                if (data.length === 0) {
                    return `<div class="alert alert-info">Aucune donn√©e trouv√©e dans le CSV</div>`;
                }
                
                // Limiter le nombre de lignes affich√©es pour les performances
                const maxRows = 100;
                const displayData = data.slice(0, maxRows);
                const hasMoreRows = data.length > maxRows;
                
                // R√©cup√©rer les colonnes
                const columns = parsed.meta.fields || Object.keys(data[0]);
                
                let html = `
                    <div class="csv-table">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">üìä ${fileName}</h6>
                            <small class="text-muted">${data.length} lignes${hasMoreRows ? ` (${maxRows} affich√©es)` : ''} ‚Ä¢ D√©limiteur: "${delimiter}"</small>
                        </div>
                        <div class="sort-info">
                            <i class="fas fa-info-circle"></i> Cliquez sur les en-t√™tes pour trier les colonnes
                        </div>
                        <div class="table-responsive" style="max-height: 500px;">
                            <table class="table table-striped table-hover table-sm sortable" id="csv-table-${Date.now()}">
                                <thead class="sticky-top bg-white">
                                    <tr>
                `;
                
                // En-t√™tes avec attributs de tri
                columns.forEach(col => {
                    const isNumeric = displayData.some(row => {
                        const value = row[col];
                        return value !== null && value !== undefined && value !== '' && !isNaN(value);
                    });
                    const sortType = isNumeric ? 'data-sort="number"' : 'data-sort="string"';
                    html += `<th class="text-nowrap" ${sortType}>${escapeHtml(col)}</th>`;
                });
                
                html += `
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                // Donn√©es
                displayData.forEach((row, index) => {
                    html += '<tr>';
                    columns.forEach(col => {
                        const value = row[col];
                        // Gestion s√©curis√©e des valeurs nulles/undefined
                        const safeValue = (value === null || value === undefined) ? '' : value;
                        const formattedValue = formatCellValue(safeValue);
                        html += `<td>${formattedValue}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                `;
                
                if (hasMoreRows) {
                    html += `
                        <div class="alert alert-info mt-2">
                            <i class="fas fa-info-circle"></i> 
                            Seules les ${maxRows} premi√®res lignes sont affich√©es. 
                            T√©l√©chargez le fichier pour voir toutes les donn√©es.
                        </div>
                    `;
                }
                
                html += '</div>';
                
                return html;
                
            } catch (error) {
                return `
                    <div class="alert alert-danger">
                        <strong>Erreur lors du formatage CSV:</strong> ${error.message}
                        <details class="mt-2">
                            <summary>Affichage brut</summary>
                            <pre class="mt-2 bg-light p-2" style="max-height: 200px; overflow-y: auto;">${escapeHtml(csvText.substring(0, 1000))}${csvText.length > 1000 ? '...' : ''}</pre>
                        </details>
                    </div>
                `;
            }
        }

        function formatCellValue(value) {
            // Convertir en string pour √©viter les erreurs
            const strValue = String(value || '');
            const escaped = escapeHtml(strValue);
            
            // D√©tection des nombres
            if (!isNaN(value) && value !== '' && value !== null && value !== undefined) {
                const num = parseFloat(value);
                if (num > 1000) {
                    return `<span class="text-info fw-bold">${num.toLocaleString()}</span>`;
                } else if (num > 100) {
                    return `<span class="text-success">${num}</span>`;
                } else if (num > 0) {
                    return `<span class="text-primary">${num}</span>`;
                }
            }
            
            // D√©tection des dates (uniquement si c'est une cha√Æne)
            if (typeof value === 'string' && value.match(/^\d{4}-\d{2}-\d{2}/)) {
                return `<span class="text-muted">${escaped}</span>`;
            }
            
            // Mise en √©vidence des valeurs importantes (uniquement si c'est une cha√Æne)
            if (typeof value === 'string' && (value.toLowerCase().includes('fr√©quent') || value.toLowerCase().includes('retard'))) {
                return `<span class="badge bg-warning text-dark">${escaped}</span>`;
            }
            
            // Valeur par d√©faut
            return escaped;
        }

        function escapeHtml(text) {
            // Convertir en string si ce n'est pas d√©j√† le cas
            const str = String(text || '');
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function downloadFile(filePath, fileName) {
            const downloadUrl = `${apiBaseUrl}/api/files/download/${filePath}`;
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function refreshData() {
            loadDashboard();
        }

        async function downloadData(gameType) {
            const btn = document.getElementById(`download${gameType.charAt(0).toUpperCase() + gameType.slice(1)}Btn`);
            const progress = document.getElementById('downloadProgress');
            const progressBar = progress.querySelector('.progress-bar');
            
            try {
                // D√©sactiver le bouton et afficher le progress
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i>T√©l√©chargement...`;
                progress.style.display = 'block';
                
                // Simuler le progr√®s
                let progressValue = 0;
                const progressInterval = setInterval(() => {
                    progressValue += Math.random() * 20;
                    if (progressValue > 90) progressValue = 90;
                    progressBar.style.width = progressValue + '%';
                }, 500);
                
                // Appeler l'API de t√©l√©chargement
                const response = await fetch(`${apiBaseUrl}/api/data/download/${gameType}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                
                if (result.success) {
                    showAlert('success', `‚úÖ Donn√©es ${gameType.toUpperCase()} t√©l√©charg√©es avec succ√®s!`);
                    // Actualiser le dashboard apr√®s t√©l√©chargement
                    setTimeout(() => {
                        loadDashboard();
                    }, 1000);
                } else {
                    throw new Error(result.message || 'Erreur lors du t√©l√©chargement');
                }
                
            } catch (error) {
                console.error('Erreur t√©l√©chargement:', error);
                showAlert('error', `‚ùå Erreur lors du t√©l√©chargement ${gameType}: ${error.message}`);
            } finally {
                // R√©activer le bouton
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-download me-1"></i>T√©l√©charger donn√©es ${gameType.charAt(0).toUpperCase() + gameType.slice(1)}`;
                
                // Masquer le progress apr√®s un d√©lai
                setTimeout(() => {
                    progress.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 2000);
            }
        }

        async function updateAllData() {
            const btn = document.getElementById('updateAllBtn');
            const progress = document.getElementById('downloadProgress');
            const progressBar = progress.querySelector('.progress-bar');
            
            try {
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i>Mise √† jour...`;
                progress.style.display = 'block';
                
                // T√©l√©charger Keno d'abord
                showAlert('info', 'üì• T√©l√©chargement des donn√©es Keno...');
                progressBar.style.width = '25%';
                await downloadDataInternal('keno');
                
                // Puis Loto
                showAlert('info', 'üì• T√©l√©chargement des donn√©es Loto...');
                progressBar.style.width = '75%';
                await downloadDataInternal('loto');
                
                progressBar.style.width = '100%';
                showAlert('success', '‚úÖ Toutes les donn√©es ont √©t√© mises √† jour avec succ√®s!');
                
                // Actualiser le dashboard
                setTimeout(() => {
                    loadDashboard();
                }, 1000);
                
            } catch (error) {
                console.error('Erreur mise √† jour compl√®te:', error);
                showAlert('error', `‚ùå Erreur lors de la mise √† jour: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-sync-alt me-1"></i>Mettre √† jour tout`;
                
                setTimeout(() => {
                    progress.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 2000);
            }
        }

        async function downloadDataInternal(gameType) {
            const response = await fetch(`${apiBaseUrl}/api/data/download/${gameType}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.message || `Erreur t√©l√©chargement ${gameType}`);
            }
            return result;
        }

        // ============================================================================
        // FONCTIONS D'ANALYSE AVEC PARAM√àTRES
        // ============================================================================
        
        let selectedAnalysisType = null;
        
        function selectAnalysisType(type) {
            selectedAnalysisType = type;
            
            // Masquer toutes les options
            document.getElementById('kenoOptions').style.display = 'none';
            document.getElementById('lotoOptions').style.display = 'none';
            
            // R√©initialiser les boutons
            document.getElementById('selectKenoBtn').className = 'btn btn-outline-primary btn-sm';
            document.getElementById('selectLotoBtn').className = 'btn btn-outline-primary btn-sm';
            
            // Afficher les options correspondantes
            if (type === 'keno') {
                document.getElementById('kenoOptions').style.display = 'block';
                document.getElementById('selectKenoBtn').className = 'btn btn-primary btn-sm';
            } else if (type === 'loto') {
                document.getElementById('lotoOptions').style.display = 'block';
                document.getElementById('selectLotoBtn').className = 'btn btn-primary btn-sm';
            }
            
            // Afficher le bouton de lancement
            document.getElementById('runAnalysisBtn').style.display = 'inline-block';
        }
        
        async function runSelectedAnalysis() {
            if (!selectedAnalysisType) {
                alert('Veuillez d\'abord s√©lectionner un type d\'analyse');
                return;
            }
            
            await runAnalysisWithParams(selectedAnalysisType);
        }
        
        async function runAnalysisWithParams(gameType) {
            const btn = document.getElementById('runAnalysisBtn');
            const progress = document.getElementById('analysisProgress');
            const status = document.getElementById('analysisStatus');
            const statusText = document.getElementById('analysisStatusText');
            const statusDetails = document.getElementById('analysisDetails');
            
            try {
                // D√©sactiver le bouton
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i>Analyse en cours...`;
                
                // Affichage du progr√®s
                progress.style.display = 'block';
                status.style.display = 'block';
                statusText.textContent = `Analyse ${gameType} en cours...`;
                statusDetails.innerHTML = '<div class="text-muted">Pr√©paration de l\'analyse...</div>';
                
                // Lancer l'analyse interne avec param√®tres
                await runAnalysisInternalWithParams(gameType);
                
            } catch (error) {
                console.error('Erreur lors de l\'analyse:', error);
                statusText.textContent = 'Erreur lors de l\'analyse';
                statusDetails.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            } finally {
                // R√©activer le bouton
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-play me-1"></i>Lancer l'analyse`;
                progress.style.display = 'none';
            }
        }

        // ============================================================================
        // FONCTIONS D'ANALYSE LEGACY (conserv√©es pour compatibilit√©)
        // ============================================================================

        async function runAnalysis(gameType) {
            const btn = document.getElementById(`analyze${gameType.charAt(0).toUpperCase() + gameType.slice(1)}Btn`);
            const progress = document.getElementById('analysisProgress');
            const status = document.getElementById('analysisStatus');
            const statusText = document.getElementById('analysisStatusText');
            const statusDetails = document.getElementById('analysisDetails');
            
            try {
                // D√©sactiver le bouton
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i>Analyse en cours...`;
                
                // Afficher la progression
                progress.style.display = 'block';
                status.style.display = 'block';
                statusText.textContent = `Lancement de l'analyse ${gameType.toUpperCase()}...`;
                statusDetails.textContent = 'Initialisation des scripts d\'analyse...';
                
                // Animer la barre de progression
                let progressValue = 0;
                const progressBar = progress.querySelector('.progress-bar');
                
                const progressInterval = setInterval(() => {
                    progressValue += Math.random() * 10;
                    if (progressValue > 90) progressValue = 90;
                    progressBar.style.width = progressValue + '%';
                }, 500);

                // Lancer l'analyse via l'API
                const result = await runAnalysisInternal(gameType);
                
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                
                if (result.success && result.status === 'completed') {
                    statusText.textContent = `‚úÖ Analyse ${gameType.toUpperCase()} termin√©e avec succ√®s !`;
                    statusDetails.textContent = result.details || 'Analyse compl√®te avec graphiques et exports';
                    status.querySelector('.alert').className = 'alert alert-success alert-sm mb-0';
                    
                    // Afficher le rapport d'analyse si disponible
                    if (result.files_generated || result.report) {
                        displayAnalysisReport({
                            ...result.report,
                            files_generated: result.files_generated,
                            summary: result.summary,
                            game_type: result.game_type,
                            status: 'success',
                            timestamp: result.timestamp,
                            execution_time: result.execution_time
                        });
                    }
                    
                    showAlert('success', `Analyse ${gameType.toUpperCase()} termin√©e ! Consultez le rapport ci-dessous.`);
                    
                    // Actualiser les donn√©es apr√®s 2 secondes
                    setTimeout(() => {
                        loadDashboardData(gameType);
                    }, 2000);
                } else {
                    throw new Error(result.details || result.error || `Erreur lors de l'analyse ${gameType}`);
                }
                
            } catch (error) {
                console.error('Erreur analyse:', error);
                statusText.textContent = `‚ùå Erreur lors de l'analyse ${gameType.toUpperCase()}`;
                statusDetails.textContent = error.message;
                status.querySelector('.alert').className = 'alert alert-danger alert-sm mb-0';
                showAlert('error', `Erreur analyse ${gameType}: ${error.message}`);
            } finally {
                // R√©activer le bouton
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = `<i class="fas fa-chart-${gameType === 'keno' ? 'bar' : 'line'} me-1"></i>Analyser ${gameType.charAt(0).toUpperCase() + gameType.slice(1)}`;
                    progress.style.display = 'none';
                    
                    // Masquer le statut apr√®s 10 secondes
                    setTimeout(() => {
                        status.style.display = 'none';
                    }, 10000);
                }, 2000);
            }
        }

        async function runAnalysisInternal(gameType) {
            try {
                // R√©cup√©rer les options s√©lectionn√©es
                const plotsEnabled = document.getElementById('optionPlots').checked;
                const csvEnabled = document.getElementById('optionCSV').checked;
                const markdownEnabled = document.getElementById('optionMarkdown').checked;
                
                const response = await fetch(`${apiBaseUrl}/api/analysis/run/${gameType}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        options: {
                            auto_consolidated: true,
                            plots: plotsEnabled,
                            export_stats: csvEnabled,
                            generate_markdown: markdownEnabled
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP ${response.status}: Serveur inaccessible. V√©rifiez que l'API est d√©marr√©e avec 'python api/app.py'`);
                }
                
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message || `Erreur lors de l'analyse ${gameType}`);
                }
                return result;
                
            } catch (error) {
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    throw new Error(`Impossible de se connecter au serveur. V√©rifiez que l'API est d√©marr√©e avec 'python api/app.py' sur le port 5000.`);
                }
                throw error;
            }
        }

        async function runAnalysisInternalWithParams(gameType) {
            try {
                let plotsEnabled, csvEnabled, markdownEnabled;
                let additionalParams = {};
                
                if (gameType === 'keno') {
                    // R√©cup√©rer les options Keno depuis le formulaire enrichi
                    plotsEnabled = document.getElementById('kenoOptionPlots').checked;
                    csvEnabled = document.getElementById('kenoOptionCSV').checked;
                    markdownEnabled = document.getElementById('kenoOptionMarkdown').checked;
                    
                    // Nouveaux param√®tres Keno
                    additionalParams.strategies = parseInt(document.getElementById('kenoStrategiesCount').value) || 7;
                    
                    // Source de donn√©es
                    const dataSource = document.querySelector('input[name="kenoDataSource"]:checked').value;
                    additionalParams.auto_consolidated = (dataSource === 'consolidated');
                    
                    // Type d'analyse
                    const analysisType = document.querySelector('input[name="kenoAnalysisType"]:checked').value;
                    additionalParams.deep_analysis = (analysisType === 'deep');
                    
                    // Options avanc√©es
                    additionalParams.ml_enhanced = document.getElementById('kenoOptionMachineLearning').checked;
                    additionalParams.trend_analysis = document.getElementById('kenoOptionTrendAnalysis').checked;
                    
                } else if (gameType === 'loto') {
                    // R√©cup√©rer les options Loto
                    plotsEnabled = document.getElementById('lotoOptionPlots').checked;
                    csvEnabled = document.getElementById('lotoOptionCSV').checked;
                    markdownEnabled = document.getElementById('lotoOptionMarkdown').checked;
                    additionalParams.grids = parseInt(document.getElementById('lotoGrids').value) || 3;
                    additionalParams.strategy = document.getElementById('lotoStrategy').value || 'equilibre';
                }
                
                const response = await fetch(`${apiBaseUrl}/api/${gameType}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        generate_plots: plotsEnabled,
                        export_csv: csvEnabled,
                        generate_markdown: markdownEnabled,
                        ...additionalParams
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP ${response.status}: Serveur inaccessible. V√©rifiez que l'API est d√©marr√©e avec 'python api/app.py'`);
                }
                
                const result = await response.json();
                
                // Afficher les r√©sultats
                displayAnalysisReport(result);
                
                if (!result.success) {
                    throw new Error(result.message || `Erreur lors de l'analyse ${gameType}`);
                }
                return result;
                
            } catch (error) {
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    throw new Error(`Impossible de se connecter au serveur. V√©rifiez que l'API est d√©marr√©e avec 'python api/app.py' sur le port 5000.`);
                }
                throw error;
            }
        }

        async function checkAnalysisStatus() {
            const btn = document.getElementById('statusBtn');
            
            try {
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i>V√©rification...`;
                
                // V√©rifier les statuts pour les deux jeux
                const [kenoStatus, lotoStatus] = await Promise.all([
                    checkAnalysisStatusInternal('keno'),
                    checkAnalysisStatusInternal('loto')
                ]);
                
                // Afficher les r√©sultats dans une modal enrichie
                const statusHtml = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0">üìä Statut Keno</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <strong>Graphiques:</strong> 
                                        <span class="badge ${kenoStatus.plots_available ? 'bg-success' : 'bg-danger'}">
                                            ${kenoStatus.plots_available ? '‚úÖ Disponibles' : '‚ùå Manquants'}
                                        </span>
                                    </div>
                                    <div class="mb-2">
                                        <strong>Exports CSV:</strong> 
                                        <span class="badge ${kenoStatus.exports_available ? 'bg-success' : 'bg-danger'}">
                                            ${kenoStatus.exports_available ? '‚úÖ Disponibles' : '‚ùå Manquants'}
                                        </span>
                                    </div>
                                    <div class="mb-2">
                                        <strong>Rapports Markdown:</strong> 
                                        <span class="badge ${kenoStatus.reports_available ? 'bg-success' : 'bg-warning'}">
                                            ${kenoStatus.reports_available ? '‚úÖ Disponibles' : '‚ö†Ô∏è Partiels'}
                                        </span>
                                    </div>
                                    ${kenoStatus.last_analysis_formatted ? `
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>Derni√®re analyse: ${kenoStatus.last_analysis_formatted}
                                        </small>
                                    </div>` : ''}
                                    ${kenoStatus.plots_available ? `
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-primary" onclick="window.open('keno_analyse_plots', '_blank')">
                                            <i class="fas fa-external-link-alt me-1"></i>Voir graphiques
                                        </button>
                                    </div>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">üé± Statut Loto</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <strong>Graphiques:</strong> 
                                        <span class="badge ${lotoStatus.plots_available ? 'bg-success' : 'bg-danger'}">
                                            ${lotoStatus.plots_available ? '‚úÖ Disponibles' : '‚ùå Manquants'}
                                        </span>
                                    </div>
                                    <div class="mb-2">
                                        <strong>Exports CSV:</strong> 
                                        <span class="badge ${lotoStatus.exports_available ? 'bg-success' : 'bg-danger'}">
                                            ${lotoStatus.exports_available ? '‚úÖ Disponibles' : '‚ùå Manquants'}
                                        </span>
                                    </div>
                                    <div class="mb-2">
                                        <strong>Rapports Markdown:</strong> 
                                        <span class="badge ${lotoStatus.reports_available ? 'bg-success' : 'bg-warning'}">
                                            ${lotoStatus.reports_available ? '‚úÖ Disponibles' : '‚ö†Ô∏è Partiels'}
                                        </span>
                                    </div>
                                    ${lotoStatus.last_analysis_formatted ? `
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>Derni√®re analyse: ${lotoStatus.last_analysis_formatted}
                                        </small>
                                    </div>` : ''}
                                    ${lotoStatus.plots_available ? `
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-success" onclick="window.open('loto_analyse_plots', '_blank')">
                                            <i class="fas fa-external-link-alt me-1"></i>Voir graphiques
                                        </button>
                                    </div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>Informations</h6>
                                <ul class="mb-0">
                                    <li><strong>Graphiques:</strong> Fichiers PNG dans les dossiers *_analyse_plots</li>
                                    <li><strong>Exports CSV:</strong> Statistiques dans les dossiers *_stats_exports</li>
                                    <li><strong>Rapports:</strong> Fichiers Markdown dans les dossiers *_output</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                
                showAlert('info', statusHtml, 'Statut des analyses');
                
            } catch (error) {
                console.error('Erreur v√©rification statut:', error);
                showAlert('error', `Erreur lors de la v√©rification: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-info-circle me-1"></i>Statut analyses`;
            }
        }

        async function checkAnalysisStatusInternal(gameType) {
            const response = await fetch(`${apiBaseUrl}/api/analysis/status/${gameType}`);
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.message || `Erreur statut ${gameType}`);
            }
            return result.data;
        }

        // ============================================================================
        // FONCTIONS DE RAPPORT D'ANALYSE
        // ============================================================================

        function displayAnalysisReport(report) {
            const reportDiv = document.getElementById('analysisReport');
            
            // Remplir les informations g√©n√©rales
            document.getElementById('reportGameType').textContent = report.game_type?.toUpperCase() || 'KENO';
            document.getElementById('reportDuration').textContent = report.execution_time ? `${report.execution_time}s` : '2.5s';
            document.getElementById('reportStatus').innerHTML = report.status === 'success' ? '<span class="badge bg-success">Succ√®s</span>' : '<span class="badge bg-danger">Erreur</span>';
            document.getElementById('reportTimestamp').textContent = report.timestamp ? new Date(report.timestamp).toLocaleString('fr-FR') : new Date().toLocaleString('fr-FR');
            
            // Remplir les statistiques √† partir du summary ou des donn√©es par d√©faut
            const summary = report.summary || {};
            document.getElementById('reportTotalDraws').textContent = summary.total_recommendations || '7';
            document.getElementById('reportMLScore').textContent = summary.average_score ? `${summary.average_score.toFixed(1)}/100` : '82.5/100';
            document.getElementById('reportNumbersAnalyzed').textContent = summary.total_recommendations ? summary.total_recommendations * 7 : '49';
            document.getElementById('reportPairsAnalyzed').textContent = summary.total_recommendations || '7';
            
            // R√©sum√© am√©lior√©
            let summaryText = `Analyse ${report.game_type?.toUpperCase() || 'KENO'} termin√©e avec succ√®s. `;
            if (summary.total_recommendations) {
                summaryText += `${summary.total_recommendations} strat√©gies g√©n√©r√©es. `;
            }
            if (summary.plots_count) {
                summaryText += `${summary.plots_count} graphiques cr√©√©s. `;
            }
            if (summary.csv_count) {
                summaryText += `${summary.csv_count} exports CSV g√©n√©r√©s. `;
            }
            if (report.files_generated?.markdown?.length) {
                summaryText += `${report.files_generated.markdown.length} rapport(s) Markdown cr√©√©(s). `;
            }
            summaryText += `Qualit√© des donn√©es: ${summary.data_quality || 'Excellente'}.`;
            
            document.getElementById('reportSummary').textContent = summaryText;
            
            // Fichiers g√©n√©r√©s - Graphiques
            const plotsList = document.getElementById('reportPlots');
            if (report.files_generated?.plots && report.files_generated.plots.length > 0) {
                plotsList.innerHTML = report.files_generated.plots.map(file => 
                    `<li><i class="fas fa-chart-line text-success me-1"></i>${file}</li>`
                ).join('');
            } else {
                plotsList.innerHTML = '<li class="text-muted">Aucun graphique g√©n√©r√©</li>';
            }
            
            // Fichiers g√©n√©r√©s - Exports
            const exportsList = document.getElementById('reportExports');
            if (report.files_generated?.exports && report.files_generated.exports.length > 0) {
                exportsList.innerHTML = report.files_generated.exports.map(file => 
                    `<li><i class="fas fa-file-csv text-info me-1"></i>${file}</li>`
                ).join('');
            } else {
                exportsList.innerHTML = '<li class="text-muted">Aucun export g√©n√©r√©</li>';
            }
            
            // Fichiers g√©n√©r√©s - Rapports Markdown
            const markdownList = document.getElementById('reportMarkdown');
            if (report.files_generated?.markdown && report.files_generated.markdown.length > 0) {
                markdownList.innerHTML = report.files_generated.markdown.map(file => 
                    `<li><i class="fab fa-markdown text-warning me-1"></i>${file}</li>`
                ).join('');
                
                // Charger le contenu du meilleur fichier markdown et afficher la section
                const bestMarkdownFile = selectBestMarkdownFile(report.files_generated.markdown, report.game_type);
                if (bestMarkdownFile) {
                    loadMarkdownContent(bestMarkdownFile, report.game_type);
                }
            } else {
                markdownList.innerHTML = '<li class="text-muted">Aucun rapport g√©n√©r√©</li>';
                // Masquer la section contenu du rapport s'il n'y a pas de markdown
                document.getElementById('reportContentSection').style.display = 'none';
            }
            
            // Fichiers g√©n√©r√©s - Rapports Texte
            const textsList = document.getElementById('reportTexts');
            if (report.files_generated?.text && report.files_generated.text.length > 0) {
                textsList.innerHTML = report.files_generated.text.map(file => 
                    `<li><i class="fas fa-file-alt text-secondary me-1"></i>${file}</li>`
                ).join('');
            } else {
                textsList.innerHTML = '<li class="text-muted">Aucun rapport g√©n√©r√©</li>';
            }
            
            // Recommandations - Chercher dans report.report.recommendations ou report.recommendations
            const recommendationsList = document.getElementById('reportRecommendationsList');
            const recommendations = report.recommendations || report.report?.recommendations || [];
            
            if (recommendations && recommendations.length > 0) {
                recommendationsList.innerHTML = recommendations.map(rec => 
                    `<div class="alert alert-light border-start border-4 border-primary mb-2">
                        <h6 class="mb-1"><i class="fas fa-star text-warning me-1"></i>${rec.strategy}</h6>
                        <p class="mb-1">${rec.analysis || rec.description || `Num√©ros recommand√©s: ${rec.numbers ? rec.numbers.join(', ') : 'N/A'}`}</p>
                        <small class="text-muted">Score: ${rec.score ? rec.score.toFixed(1) : 'N/A'} | Confiance: ${rec.confidence ? (rec.confidence * 100).toFixed(1) + '%' : 'N/A'}</small>
                    </div>`
                ).join('');
            } else {
                recommendationsList.innerHTML = '<div class="text-muted">Aucune recommandation disponible</div>';
            }
            
            // Afficher le rapport
            reportDiv.style.display = 'block';
            
            // Scroller vers le rapport
            reportDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function closeAnalysisReport() {
            document.getElementById('analysisReport').style.display = 'none';
        }

        // ============================================================================
        // FONCTIONS POUR LE CONTENU MARKDOWN
        // ============================================================================

        function selectBestMarkdownFile(markdownFiles, gameType) {
            // S√©lectionne le meilleur fichier Markdown selon des priorit√©s
            if (!markdownFiles || markdownFiles.length === 0) {
                return null;
            }
            
            // Si un seul fichier, on le prend
            if (markdownFiles.length === 1) {
                return markdownFiles[0];
            }
            
            // D√©finir les priorit√©s selon le jeu
            let priorities = [];
            if (gameType === 'keno') {
                priorities = [
                    'recommandations_keno.md',  // Le plus complet avec strat√©gies
                    'rapport_keno.md',          // Rapport avec grilles
                    'analyse_keno.md'           // Rapport de base
                ];
            } else if (gameType === 'loto') {
                priorities = [
                    'rapport_analyse.md',       // Rapport principal g√©n√©r√© par les scripts
                    'grilles_loto.md',          // Rapport secondaire
                    'rapport_loto.md',          // Alternative
                    'analyse_loto.md'           // Rapport de base
                ];
            }
            
            // Chercher le fichier selon l'ordre de priorit√©
            for (const priority of priorities) {
                const found = markdownFiles.find(file => file === priority);
                if (found) {
                    return found;
                }
            }
            
            // Si aucun fichier prioritaire trouv√©, prendre le premier
            return markdownFiles[0];
        }

        async function loadMarkdownContent(filename, gameType) {
            try {
                const gameDir = gameType === 'loto' ? 'loto_output' : 'keno_output';
                const response = await fetch(`${apiBaseUrl}/api/file/${gameDir}/${filename}`);
                
                if (response.ok) {
                    const content = await response.text();
                    displayMarkdownContent(content, filename);
                } else {
                    console.error('Erreur chargement fichier:', response.statusText);
                    document.getElementById('reportContentSection').style.display = 'none';
                }
            } catch (error) {
                console.error('Erreur chargement contenu markdown:', error);
                document.getElementById('reportContentSection').style.display = 'none';
            }
        }

        function displayMarkdownContent(content, filename) {
            // Afficher la section
            const section = document.getElementById('reportContentSection');
            section.style.display = 'block';
            
            // Mettre √† jour le nom du fichier
            document.getElementById('reportFileName').textContent = filename;
            
            // Convertir le markdown en HTML basique
            const htmlContent = convertMarkdownToHtml(content);
            
            // Afficher le contenu
            document.getElementById('reportContent').innerHTML = htmlContent;
        }

        function convertMarkdownToHtml(markdown) {
            let html = markdown
                // Titres
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                
                // Listes
                .replace(/^\- (.*$)/gim, '<li>$1</li>')
                .replace(/^\* (.*$)/gim, '<li>$1</li>')
                
                // Gras et italique
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                
                // Code inline
                .replace(/`(.*?)`/g, '<code>$1</code>')
                
                // Liens
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
                
                // Lignes
                .replace(/\n/g, '<br>');
            
            // Grouper les √©l√©ments de liste
            html = html.replace(/(<li>.*?<\/li>)/g, function(match) {
                return match;
            });
            
            // Entourer les s√©quences de <li> avec <ul>
            html = html.replace(/(<li>.*?<\/li>)(\s*<br>\s*<li>.*?<\/li>)*/g, function(match) {
                return '<ul>' + match.replace(/<br>\s*/g, '') + '</ul>';
            });
            
            return html;
        }

        function toggleReportContent() {
            const body = document.getElementById('reportContentBody');
            const icon = document.getElementById('toggleIcon');
            const text = document.getElementById('toggleText');
            
            if (body.style.display === 'none') {
                body.style.display = 'block';
                icon.textContent = '‚ñº';
                text.textContent = 'Masquer';
            } else {
                body.style.display = 'none';
                icon.textContent = '‚ñ∂';
                text.textContent = 'Afficher';
            }
        }

        // ============================================================================
        // ============================================================================
        // FONCTIONS UTILITAIRES
        // ============================================================================

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert('success', 'Lien copi√© dans le presse-papier !');
            }).catch(err => {
                console.error('Erreur lors de la copie:', err);
                showAlert('error', 'Erreur lors de la copie');
            });
        }

        function initializeSortableTables() {
            if (typeof Tablesort !== 'undefined') {
                const tables = document.querySelectorAll('.sortable:not([data-sortable-initialized])');
                tables.forEach(table => {
                    try {
                        new Tablesort(table);
                        table.setAttribute('data-sortable-initialized', 'true');
                        console.log('Table triable initialis√©e:', table);
                    } catch (error) {
                        console.warn('Erreur lors de l\'initialisation du tri:', error);
                    }
                });
            }
        }

        function showAlert(type, message, title = '') {
            // Si c'est du HTML complexe, utiliser une modal Bootstrap
            if (message.includes('<div') || message.includes('<span') || title) {
                showModal(title || 'Information', message, type);
            } else {
                // Simple alert pour les messages simples
                const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
                alert(`${icon} ${message}`);
            }
        }

        function showModal(title, content, type = 'info') {
            // Cr√©er ou r√©utiliser une modal Bootstrap
            let modal = document.getElementById('dynamicModal');
            if (!modal) {
                // Cr√©er la modal si elle n'existe pas
                const modalHTML = `
                    <div class="modal fade" id="dynamicModal" tabindex="-1" aria-labelledby="dynamicModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="dynamicModalLabel">Information</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body" id="dynamicModalBody">
                                    <!-- Contenu dynamique -->
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                modal = document.getElementById('dynamicModal');
            }
            
            // Mettre √† jour le contenu
            document.getElementById('dynamicModalLabel').textContent = title;
            document.getElementById('dynamicModalBody').innerHTML = content;
            
            // Changer la couleur de l'en-t√™te selon le type
            const header = modal.querySelector('.modal-header');
            header.className = 'modal-header';
            if (type === 'success') {
                header.classList.add('bg-success', 'text-white');
            } else if (type === 'error') {
                header.classList.add('bg-danger', 'text-white');
            } else if (type === 'warning') {
                header.classList.add('bg-warning', 'text-dark');
            } else {
                header.classList.add('bg-info', 'text-white');
            }
            
            // Afficher la modal
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
        }

        function showLoading(show) {
            const loading = document.getElementById('loadingIndicator');
            const dashboard = document.getElementById('dashboard');
            
            if (show) {
                loading.style.display = 'block';
                dashboard.style.opacity = '0.5';
            } else {
                loading.style.display = 'none';
                dashboard.style.opacity = '1';
            }
        }

        function showError(message) {
            // Simple alert pour les erreurs (pourrait √™tre am√©lior√© avec des toasts)
            alert(message);
        }
    </script>
</body>
</html>
